{% extends 'admin/base.html.twig' %}

{% block title %}Liste d'affectation{% endblock %}

{% block content %}
<div class="admin-container">
    <div class="admin-header">
        <h1>üìã Liste d'affectation</h1>
        <p>Gestion des affectations par agence et lot</p>
    </div>

    {% if error %}
        <div style="background: #fed7d7; color: #c53030; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #e53e3e;">
            <strong>‚ùå Erreur :</strong> {{ error }}
        </div>
    {% endif %}

    <div class="admin-content">
        {# Statistiques #}
        {% if stats %}
        <div class="stats" style="margin-bottom: 30px;">
            <div class="stat-card">
                <h3>{{ stats.TOTAL_LOTS|default(0) }}</h3>
                <p>Total des lots</p>
            </div>
            <div class="stat-card">
                <h3>{{ stats.TOTAL_AGENCES|default(0) }}</h3>
                <p>Agences</p>
            </div>
            <div class="stat-card">
                <h3>{{ stats.LOTS_AVEC_GARDIEN|default(0) }}</h3>
                <p>Lots avec gardien</p>
            </div>
            <div class="stat-card">
                <h3>{{ stats.LOTS_AVEC_TELEPHONE|default(0) }}</h3>
                <p>Lots avec t√©l√©phone</p>
            </div>
            <div class="stat-card">
                <h3>{{ stats.LOTS_AVEC_EMAIL|default(0) }}</h3>
                <p>Lots avec email</p>
            </div>
        </div>
        {% endif %}

        {# Barre de recherche et filtres #}
        <div class="search-container">
            <form method="GET" action="{{ path('admin_liste_affectation') }}" id="searchForm" style="display: flex; gap: 15px; align-items: center; width: 100%; flex-wrap: wrap;">
                <input type="text" 
                       name="search" 
                       value="{{ search }}" 
                       placeholder="Rechercher par LOT..." 
                       class="search-input"
                       style="flex: 1; min-width: 250px;"
                       id="searchInput">
                
                <select name="groupe" class="search-input" style="flex: 0 0 200px;" id="groupeSelect">
                    <option value="">Tous les groupes</option>
                    {% for groupeOption in groupes %}
                        <option value="{{ groupeOption }}" {% if groupe == groupeOption %}selected{% endif %}>
                            {{ groupeOption }}
                        </option>
                    {% endfor %}
                </select>
                
                <button type="submit" class="btn" id="searchBtn">üîç Rechercher</button>
                {% if search or groupe %}
                    <a href="{{ path('admin_liste_affectation') }}" class="btn btn-secondary">‚ùå Effacer</a>
                {% endif %}
            </form>
        </div>

        {# Indicateur de chargement #}
        <div id="loadingIndicator" style="display: none; text-align: center; padding: 20px; color: #4299e1;">
            <div style="display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #4299e1; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            <span style="margin-left: 10px;">Recherche en cours...</span>
        </div>

        {# Tableau des affectations #}
        <div class="table-container">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>Agence</th>
                        <th>Groupe</th>
                        <th>LOT</th>
                        <th>Nature du lot</th>
                        <th>Gardien du lot</th>
                        <th>T√©l√©phone</th>
                        <th>Email</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% if data is empty %}
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 40px; color: #718096;">
                                {% if search or groupe %}
                                    Aucun r√©sultat trouv√©
                                    {% if search %}pour "{{ search }}"{% endif %}
                                    {% if groupe %}dans le groupe "{{ groupe }}"{% endif %}
                                {% else %}
                                    Aucune affectation trouv√©e
                                {% endif %}
                            </td>
                        </tr>
                    {% else %}
                        {% for affectation in data %}
                        <tr>
                            <td>{{ affectation.AGENCE|default('-') }}</td>
                            <td>{{ affectation.GROUPE|default('-') }}</td>
                            <td><strong>{{ affectation.LOT|default('-') }}</strong></td>
                            <td>{{ affectation.NATURE_LOT|default('-') }}</td>
                            <td>{{ affectation.GARDIEN_LOT|default('-') }}</td>
                            <td>
                                {% if affectation.GARD_TEL %}
                                    <a href="tel:{{ affectation.GARD_TEL }}" style="color: #4299e1; text-decoration: none;">
                                        {{ affectation.GARD_TEL }}
                                    </a>
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>
                                {% if affectation.GARD_MAIL %}
                                    <a href="mailto:{{ affectation.GARD_MAIL }}" style="color: #4299e1; text-decoration: none;">
                                        {{ affectation.GARD_MAIL }}
                                    </a>
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>
                                <a href="{{ path('admin_liste_affectation_detail', {lot: affectation.LOT}) }}" 
                                   class="btn" 
                                   style="padding: 6px 12px; font-size: 12px;">
                                    üëÅÔ∏è D√©tails
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    {% endif %}
                </tbody>
            </table>
        </div>

        {# Pagination #}
        {% if pagination.totalPages > 1 %}
        <div class="pagination">
            {# Premi√®re page #}
            {% if pagination.page > 1 %}
                <a href="{{ path('admin_liste_affectation', {page: 1, search: search, groupe: groupe}) }}" class="btn btn-secondary" style="padding: 8px 12px; font-size: 14px;">‚èÆÔ∏è Premi√®re</a>
            {% endif %}
            
            {# Page pr√©c√©dente #}
            {% if pagination.page > 1 %}
                <a href="{{ path('admin_liste_affectation', {page: pagination.page - 1, search: search, groupe: groupe}) }}" class="btn btn-secondary" style="padding: 8px 12px; font-size: 14px;">¬´ Pr√©c√©dent</a>
            {% endif %}
            
            {# Page actuelle #}
            <span class="current" style="padding: 8px 16px; background: #4299e1; color: white; border-radius: 6px; font-weight: 600;">
                Page {{ pagination.page }} sur {{ pagination.totalPages }}
            </span>
            
            {# Page suivante #}
            {% if pagination.page < pagination.totalPages %}
                <a href="{{ path('admin_liste_affectation', {page: pagination.page + 1, search: search, groupe: groupe}) }}" class="btn btn-secondary" style="padding: 8px 12px; font-size: 14px;">Suivant ¬ª</a>
            {% endif %}
            
            {# Derni√®re page #}
            {% if pagination.page < pagination.totalPages %}
                <a href="{{ path('admin_liste_affectation', {page: pagination.totalPages, search: search, groupe: groupe}) }}" class="btn btn-secondary" style="padding: 8px 12px; font-size: 14px;">Derni√®re ‚è≠Ô∏è</a>
            {% endif %}
        </div>
        {% endif %}

        {# Informations de pagination #}
        <div style="text-align: center; margin-top: 20px; color: #718096; font-size: 14px;">
            Affichage de {{ data|length }} r√©sultat(s) sur {{ pagination.total }} total
            {% if pagination.totalPages > 1 %}
                - Page {{ pagination.page }} sur {{ pagination.totalPages }}
            {% endif %}
        </div>
    </div>
</div>

<style>
    .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 12px;
        text-align: center;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .stat-card h3 {
        font-size: 2rem;
        margin-bottom: 5px;
        font-weight: 700;
    }
    
    .stat-card p {
        opacity: 0.9;
        font-size: 0.9rem;
        margin: 0;
    }
    
    .search-container {
        margin-bottom: 20px;
        display: flex;
        gap: 15px;
        align-items: center;
        flex-wrap: wrap;
    }
    
    .search-input {
        flex: 1;
        min-width: 300px;
        padding: 12px 16px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 16px;
        transition: all 0.3s ease;
    }
    
    .search-input:focus {
        outline: none;
        border-color: #4299e1;
        box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
    }
    
    .search-input select {
        background: white;
        cursor: pointer;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .table-container {
        overflow-x: auto;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
    }
    
    .admin-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
    }
    
    .admin-table th {
        background: #f7fafc;
        padding: 16px 12px;
        text-align: left;
        font-weight: 600;
        color: #4a5568;
        border-bottom: 2px solid #e2e8f0;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    .admin-table td {
        padding: 12px;
        border-bottom: 1px solid #e2e8f0;
        vertical-align: top;
    }
    
    .admin-table tr:hover {
        background: #f7fafc;
    }
    
    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        margin-top: 20px;
        flex-wrap: wrap;
    }
    
    .pagination a, .pagination span {
        padding: 8px 12px;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        text-decoration: none;
        color: #4a5568;
        transition: all 0.3s ease;
    }
    
    .pagination a:hover {
        background: #4299e1;
        color: white;
        border-color: #4299e1;
    }
    
    .pagination .current {
        background: #4299e1;
        color: white;
        border-color: #4299e1;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchForm = document.getElementById('searchForm');
    const searchBtn = document.getElementById('searchBtn');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const searchInput = document.getElementById('searchInput');
    const groupeSelect = document.getElementById('groupeSelect');
    
    // Gestion du chargement lors de la soumission du formulaire
    searchForm.addEventListener('submit', function() {
        searchBtn.disabled = true;
        searchBtn.innerHTML = '‚è≥ Recherche...';
        loadingIndicator.style.display = 'block';
    });
    
    // Recherche automatique lors de la s√©lection d'un groupe
    groupeSelect.addEventListener('change', function() {
        searchForm.submit();
    });
    
    // Recherche automatique avec d√©lai lors de la saisie (optionnel)
    let searchTimeout;
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(function() {
            // Optionnel: recherche automatique apr√®s 1 seconde d'inactivit√©
            // searchForm.submit();
        }, 1000);
    });
    
    // Raccourci clavier pour la recherche
    searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            searchForm.submit();
        }
    });
});
</script>
{% endblock %}
