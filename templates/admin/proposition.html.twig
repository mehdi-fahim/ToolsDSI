{% extends 'admin/base.html.twig' %}

{% block title %}Proposition - Suppression{% endblock %}

{% block content %}
<div style="max-width: 1100px; margin: 0 auto;">
  <div style="background:#fff;border-radius:15px;box-shadow:0 8px 32px rgba(0,0,0,0.08);border:1px solid #eef2f7;padding:28px 28px 22px;margin-bottom:18px;">
    <h1 style="font-size:1.6rem;color:#232946;font-weight:700;margin-bottom:16px;">Gestion des propositions</h1>

    {% if error %}
      <div style="margin-bottom:12px;border:1px solid #fecaca;background:#fef2f2;color:#991b1b;border-radius:10px;padding:10px 14px;">{{ error }}</div>
    {% endif %}
    {% if success %}
      <div style="margin-bottom:12px;border:1px solid #bbf7d0;background:#f0fdf4;color:#065f46;border-radius:10px;padding:10px 14px;">{{ success }}</div>
    {% endif %}

    <form action="{{ path('admin_proposition') }}" method="post" style="display:flex;gap:12px;align-items:flex-end;flex-wrap:wrap;">
      <div style="display:flex;flex-direction:column;gap:6px;">
        <label style="font-weight:600;color:#232946;font-size:0.95rem;">Numéro de proposition</label>
        <input type="number" name="numero_proposition" value="{{ numero ?? '' }}" required style="padding:10px 12px;border:1.5px solid #e2e8f0;border-radius:8px;background:#f7fafc;width:220px;">
      </div>
      <button type="submit" class="btn" style="background:#ff6600;">Rechercher</button>
    </form>
  </div>

  {% if numero and candidats is not empty %}
    <div style="background:#fff;border-radius:15px;box-shadow:0 8px 32px rgba(0,0,0,0.08);border:1px solid #eef2f7;padding:22px 24px;margin-bottom:18px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
        <h2 style="font-size:1.2rem;color:#232946;font-weight:700;">Candidats de la proposition {{ numero }}</h2>
        <form action="{{ path('admin_proposition') }}" method="post" onsubmit="return confirm('Supprimer tous les candidats ?');">
          <input type="hidden" name="numero_proposition" value="{{ numero }}">
          <input type="hidden" name="action" value="delete_all_candidates">
          <button type="submit" class="btn btn-danger">Supprimer tous les candidats</button>
        </form>
      </div>

      <div class="table-container">
        <table class="admin-table">
          <thead>
            <tr>
              <th>Prénom</th>
              <th>Nom</th>
              <th>Date naissance</th>
              <th>N° tiers</th>
              <th>N° dossier</th>
              <th>Créé le</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for c in candidats %}
              <tr>
                <td>{{ c.PRENOM }}</td>
                <td>{{ c.NOM }}</td>
                <td>{{ c.DATE_NAISSANCE }}</td>
                <td>{{ c.NUMERO_TIERS }}</td>
                <td>{{ c.NUMERO_DOSSIER }}</td>
                <td>{{ c.DATE_CREATION }}</td>
                <td>
                  <form action="{{ path('admin_proposition') }}" method="post" onsubmit="return confirm('Supprimer ce candidat ?');" style="display:inline;">
                    <input type="hidden" name="numero_proposition" value="{{ numero }}">
                    <input type="hidden" name="numero_tiers" value="{{ c.NUMERO_TIERS }}">
                    <input type="hidden" name="numero_dossier" value="{{ c.NUMERO_DOSSIER }}">
                    <input type="hidden" name="action" value="delete_candidate">
                    <button type="submit" class="btn btn-danger" style="padding:6px 10px;font-size:12px;">Supprimer</button>
                  </form>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div style="margin-top:14px;">
        <form action="{{ path('admin_proposition') }}" method="post" onsubmit="return openConfirmModal(event, 'Confirmer la suppression de la proposition ?');">
          <input type="hidden" name="numero_proposition" value="{{ numero }}">
          <input type="hidden" name="action" value="delete_proposition">
          <button type="submit" class="btn btn-danger">Supprimer la proposition</button>
        </form>
      </div>
    </div>

  {% elseif numero and proposition %}
    <div style="background:#fff;border-radius:15px;box-shadow:0 8px 32px rgba(0,0,0,0.08);border:1px solid #eef2f7;padding:22px 24px;">
      <h2 style="font-size:1.2rem;color:#232946;font-weight:700;margin-bottom:10px;">Proposition {{ numero }}</h2>
      <div class="table-container">
        <table class="admin-table">
          <thead>
            <tr>
              <th>N° proposition</th>
              <th>Tiers Rés.</th>
              <th>Libellé Rés.</th>
              <th>Code ESI</th>
              <th>Nature</th>
              <th>Adresse</th>
              <th>CP</th>
              <th>Commune</th>
              <th>Lib. Garantie</th>
              <th>Créée le</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>{{ proposition.ACPRS_NUM }}</td>
              <td>{{ proposition.TOTIE_COD_RES }}</td>
              <td>{{ proposition.TOTIE_LIB }}</td>
              <td>{{ proposition.PAESI_CODEXT }}</td>
              <td>{{ proposition.PANES_COD }}</td>
              <td>{{ proposition.MGADR_LIB }}</td>
              <td>{{ proposition.MGADR_CODPOS }}</td>
              <td>{{ proposition.MGADR_LIBCOM }}</td>
              <td>{{ proposition.TOTIE_LIB_GAR }}</td>
              <td>{{ proposition.ACPRS_DATCRE }}</td>
            </tr>
          </tbody>
        </table>
      </div>
      <form action="{{ path('admin_proposition') }}" method="post" style="margin-top:14px;" onsubmit="return openConfirmModal(event, 'Confirmer la suppression de la proposition ?');">
        <input type="hidden" name="numero_proposition" value="{{ numero }}">
        <input type="hidden" name="action" value="delete_proposition">
        <button type="submit" class="btn btn-danger">Supprimer la proposition</button>
      </form>
    </div>

  {% elseif numero %}
    <div style="margin-top:10px;border:1px solid #fde68a;background:#fffbeb;color:#92400e;border-radius:10px;padding:10px 14px;">Aucun candidat ni proposition trouvés pour ce numéro.</div>
  {% endif %}
</div>
{% endblock %}

{% block javascript %}
  <script>
    function openConfirmModal(e, message) {
      e.preventDefault();
      const overlay = document.createElement('div');
      overlay.style.position = 'fixed';
      overlay.style.inset = '0';
      overlay.style.background = 'rgba(0,0,0,0.4)';
      overlay.style.display = 'flex';
      overlay.style.alignItems = 'center';
      overlay.style.justifyContent = 'center';
      overlay.style.zIndex = '9999';

      const modal = document.createElement('div');
      modal.style.background = '#fff';
      modal.style.borderRadius = '12px';
      modal.style.padding = '20px';
      modal.style.width = '420px';
      modal.style.boxShadow = '0 10px 30px rgba(0,0,0,0.15)';

      modal.innerHTML = `
        <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 10px;">Confirmation</h3>
        <p style="font-size: 14px; color: #4a5568; margin-bottom: 16px;">${message}</p>
        <div style="display:flex; gap:10px; justify-content:flex-end;">
          <button id="cancelBtn" style="padding:8px 14px; border-radius:8px; border:1px solid #e2e8f0; background:#fff;">Annuler</button>
          <button id="confirmBtn" style="padding:8px 14px; border-radius:8px; background:#e11d48; color:#fff;">Confirmer</button>
        </div>
      `;

      overlay.appendChild(modal);
      document.body.appendChild(overlay);

      modal.querySelector('#cancelBtn').addEventListener('click', () => {
        document.body.removeChild(overlay);
      });
      modal.querySelector('#confirmBtn').addEventListener('click', () => {
        // Soumettre le formulaire original
        const form = e.target;
        form.submit();
      });

      return false;
    }
  </script>
{% endblock %}
