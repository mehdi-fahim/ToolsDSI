{% extends 'admin/base.html.twig' %}

{% block title %}Int√©gration OD{% endblock %}

{% block content %}
<div class="admin-container">
    <div class="admin-header">
        <h1>üìä Int√©gration OD</h1>
        <p>Import et int√©gration de fichiers CSV pour les donn√©es OD</p>
    </div>

    <div class="admin-content">
        {% if error %}
            <div style="background: #fed7d7; color: #c53030; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #e53e3e;">
                <strong>‚ùå Erreur :</strong> {{ error }}
            </div>
        {% endif %}

        {% if success %}
            <div style="background: #c6f6d5; color: #2f855a; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #38a169;">
                <strong>‚úÖ Succ√®s :</strong> {{ success }}
            </div>
        {% endif %}

        {% if not csvData %}
            {# Formulaire d'upload #}
            <div style="background: #f7fafc; padding: 30px; border-radius: 12px; border: 2px dashed #cbd5e0; text-align: center;">
                <h3 style="color: #4a5568; margin-bottom: 20px;">üìÅ S√©lectionner un fichier CSV</h3>
                <p style="color: #718096; margin-bottom: 30px;">
                    Veuillez s√©lectionner un fichier CSV contenant les donn√©es OD √† int√©grer.
                </p>
                
                <form method="POST" action="{{ path('admin_import_od_upload') }}" enctype="multipart/form-data" style="max-width: 400px; margin: 0 auto;">
                    <div style="margin-bottom: 20px;">
                        <input type="file" 
                               name="csv_file" 
                               accept=".csv" 
                               required
                               style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px; background: white;">
                    </div>
                    
                    <button type="submit" class="btn">
                        üì§ Charger le fichier
                    </button>
                </form>
                
                <div style="margin-top: 30px; text-align: left; background: white; padding: 20px; border-radius: 8px;">
                    <h4 style="color: #4a5568; margin-bottom: 15px;">üìã Format attendu :</h4>
                    <p style="color: #718096; font-size: 14px; margin-bottom: 10px;">Le fichier CSV doit contenir les colonnes suivantes :</p>
                    <ul style="color: #718096; font-size: 14px; margin: 0; padding-left: 20px;">
                        <li><strong>PAESI_CODEXT</strong> - Code externe (obligatoire)</li>
                        <li><strong>PAESI_LIBELLE</strong> - Libell√© (obligatoire)</li>
                        <li><strong>PAESI_CODE</strong> - Code</li>
                        <li><strong>PAESI_TYPE</strong> - Type</li>
                        <li><strong>PAESI_ACTIF</strong> - Actif</li>
                        <li><strong>PAESI_ORDRE</strong> - Ordre</li>
                        <li><strong>PAESI_COMMENTAIRE</strong> - Commentaire</li>
                    </ul>
                </div>
            </div>
        {% else %}
            {# Aper√ßu des donn√©es #}
            <div style="background: #f7fafc; padding: 30px; border-radius: 12px; margin-bottom: 20px;">
                <h3 style="color: #4a5568; margin-bottom: 20px;">üëÅÔ∏è Aper√ßu des donn√©es</h3>
                <p style="color: #718096; margin-bottom: 20px;">
                    <strong>{{ csvData.total_rows }}</strong> lignes trouv√©es dans le fichier CSV.
                    V√©rifiez les donn√©es ci-dessous avant de proc√©der √† l'int√©gration.
                </p>
                
                <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                    <form method="POST" action="{{ path('admin_import_od_integrate') }}" style="display: inline;">
                        <button type="submit" class="btn btn-success" onclick="return confirm('√ätes-vous s√ªr de vouloir int√©grer ces donn√©es ?')">
                            ‚úÖ Int√©grer les donn√©es
                        </button>
                    </form>
                    
                    <a href="{{ path('admin_import_od') }}" class="btn btn-secondary">
                        üîÑ Recommencer
                    </a>

                    <form method="POST" action="{{ path('admin_import_od_clear') }}" style="display: inline;" onsubmit="return confirm('Confirmer le vidage de la table OD_A_CHARGER ?')">
                        <button type="submit" class="btn btn-danger">
                            üóëÔ∏è Vider OD_A_CHARGER
                        </button>
                    </form>
                </div>
            </div>

            {# Tableau de pr√©visualisation #}
            <div class="table-container">
                <table class="admin-table">
                    <thead>
                        <tr>
                            {% for header in csvData.headers %}
                                <th>{{ header }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in csvData.data %}
                            <tr>
                                {% for header in csvData.headers %}
                                    <td>
                                        {% if row[header] is defined %}
                                            {{ row[header] }}
                                        {% else %}
                                            <span style="color: #a0aec0;">-</span>
                                        {% endif %}
                                    </td>
                                {% endfor %}
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% endif %}
    </div>
</div>

<style>
    .table-container {
        max-height: 600px;
        overflow-y: auto;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
    }
    
    .admin-table th {
        position: sticky;
        top: 0;
        background: #f7fafc;
        z-index: 10;
    }
    
    .admin-table td {
        font-size: 14px;
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    .admin-table td:hover {
        white-space: normal;
        word-break: break-word;
    }
</style>
{% endblock %}
