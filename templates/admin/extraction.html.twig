{% extends 'admin/base.html.twig' %}

{% block title %}Extracteur fichier .CSV par Groupe - Panel Admin{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        .checkbox-container {
            position: relative;
        }
        
        .checkbox-container input[type="checkbox"]:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .checkbox-container input[type="checkbox"]:disabled + span {
            color: #718096;
            font-style: italic;
        }
        
        .auto-checked {
            background-color: #f0fff4;
            border: 1px solid #68d391;
            border-radius: 4px;
            padding: 2px 6px;
            margin-left: 8px;
            font-size: 0.75rem;
            color: #38a169;
        }
        
        .auto-checked-field {
            background-color: #f0fff4;
            border: 1px solid #68d391;
            border-radius: 6px;
            padding: 8px;
        }
        
        .auto-checked-field input[type="checkbox"]:disabled {
            opacity: 0.8;
        }
        
        .auto-checked-field span {
            color: #38a169;
            font-weight: 500;
        }
        
        .section-header {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-info {
            font-size: 0.8rem;
            color: #718096;
            font-style: italic;
        }
    </style>
{% endblock %}

{% block content %}
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 15px;">
        <div>
            <h2 style="color: #2d3748; font-size: 1.8rem; margin-bottom: 5px;">üìä Extracteur fichier .CSV par Groupe</h2>
            <p style="color: #718096;">G√©n√©rez des fichiers CSV personnalis√©s par groupe SI</p>
        </div>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <a href="{{ path('admin_dashboard') }}" class="btn btn-secondary">üè† Dashboard</a>
        </div>
    </div>

    <!-- Informations sur les r√®gles automatiques -->
    <div style="background: #e6fffa; border: 1px solid #38b2ac; border-radius: 8px; padding: 20px; margin-bottom: 30px;">
        <h3 style="color: #2c7a7b; margin-bottom: 15px;">‚ÑπÔ∏è R√®gles de s√©lection automatique</h3>
        <div style="color: #2c7a7b; font-size: 0.9rem; line-height: 1.6;">
            <p><strong>Locataire :</strong> Si vous s√©lectionnez Libell√© Intitul√©, T√©l√©phone, Age ou Adresse de regroupement, le champ Tiers sera automatiquement coch√©.</p>
            <p><strong>Locataire/M√©nage/Loyer :</strong> Si vous s√©lectionnez certains champs sp√©cifiques, les champs Contrat et Intitul√© seront automatiquement coch√©s (champs obligatoires).</p>
            <p style="margin-top: 10px; font-style: italic;">Les champs coch√©s automatiquement sont d√©sactiv√©s pour √©viter les erreurs de s√©lection.</p>
        </div>
    </div>

    {% if error is defined and error %}
        <div style="background: #fed7d7; border: 1px solid #f56565; border-radius: 8px; padding: 20px; margin-bottom: 30px;">
            <h3 style="color: #c53030; margin-bottom: 10px;">‚ö†Ô∏è Erreur</h3>
            <p style="color: #742a2a; margin: 0;">{{ error }}</p>
        </div>
    {% endif %}

    <form method="POST" action="{{ path('admin_extraction') }}" style="background: white; border-radius: 12px; padding: 30px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
        
        <!-- Champ de recherche Groupe SI -->
        <div style="margin-bottom: 30px;">
            <label for="groupe_si" style="display: block; margin-bottom: 10px; color: #4a5568; font-weight: 600; font-size: 1.1rem;">
                Extracteur fichier .CSV par Groupe (ex: SD3400):
            </label>
            <input type="text" 
                   id="groupe_si" 
                   name="groupe_si" 
                   value="{{ groupeSi }}"
                   placeholder="Ex: SD3400"
                   style="width: 100%; max-width: 400px; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px;">
        </div>

        <!-- Label Donn√©es disponibles -->
        <div style="margin-bottom: 20px;">
            <h3 style="color: #2d3748; font-size: 1.2rem; margin-bottom: 15px;">Donn√©es disponibles:</h3>
        </div>

        <!-- Section Patrimoine -->
        <div style="margin-bottom: 30px;">
            <h4 style="color: #4a5568; font-size: 1.1rem; margin-bottom: 15px; border-bottom: 2px solid #e2e8f0; padding-bottom: 8px;">
                Patrimoine :
            </h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <label class="checkbox-container" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" name="fields[]" value="esi" {{ 'esi' in selectedFields ? 'checked' : '' }} style="width: 16px; height: 16px;">
                    <span>Esi</span>
                </label>
                <label class="checkbox-container" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" name="fields[]" value="etage" {{ 'etage' in selectedFields ? 'checked' : '' }} style="width: 16px; height: 16px;">
                    <span>Etage</span>
                </label>
                <label class="checkbox-container" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" name="fields[]" value="typologie" {{ 'typologie' in selectedFields ? 'checked' : '' }} style="width: 16px; height: 16px;">
                    <span>Typologie</span>
                </label>
                <label class="checkbox-container" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" name="fields[]" value="nature" {{ 'nature' in selectedFields ? 'checked' : '' }} style="width: 16px; height: 16px;">
                    <span>Nature</span>
                </label>
                <label class="checkbox-container" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" name="fields[]" value="adresse" {{ 'adresse' in selectedFields ? 'checked' : '' }} style="width: 16px; height: 16px;">
                    <span>Adresse</span>
                </label>
                <label class="checkbox-container" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" name="fields[]" value="groupe" {{ 'groupe' in selectedFields ? 'checked' : '' }} style="width: 16px; height: 16px;">
                    <span>Groupe</span>
                </label>
                <label class="checkbox-container" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" name="fields[]" value="agence" {{ 'agence' in selectedFields ? 'checked' : '' }} style="width: 16px; height: 16px;">
                    <span>Agence</span>
                </label>
                <label class="checkbox-container" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" name="fields[]" value="statut" {{ 'statut' in selectedFields ? 'checked' : '' }} style="width: 16px; height: 16px;">
                    <span>Statut</span>
                </label>
                <label class="checkbox-container" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" name="fields[]" value="surface_habitable" {{ 'surface_habitable' in selectedFields ? 'checked' : '' }} style="width: 16px; height: 16px;">
                    <span>Surface Habitable</span>
                </label>
                <label class="checkbox-container" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" name="fields[]" value="surface_utile" {{ 'surface_utile' in selectedFields ? 'checked' : '' }} style="width: 16px; height: 16px;">
                    <span>Surface Utile</span>
                </label>
                <label class="checkbox-container" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" name="fields[]" value="numero_rpls" {{ 'numero_rpls' in selectedFields ? 'checked' : '' }} style="width: 16px; height: 16px;">
                    <span>Num√©ro RPLS</span>
                </label>
                <label class="checkbox-container" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" name="fields[]" value="cat_financement" {{ 'cat_financement' in selectedFields ? 'checked' : '' }} style="width: 16px; height: 16px;">
                    <span>Cat. Financement</span>
                </label>
                <label class="checkbox-container" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" name="fields[]" value="reservataire" {{ 'reservataire' in selectedFields ? 'checked' : '' }} style="width: 16px; height: 16px;">
                    <span>R√©servataire</span>
                </label>
            </div>
        </div>

        <!-- Section Locataire -->
        <div style="margin-bottom: 30px;">
            <div class="section-header">
                <h4 style="color: #4a5568; font-size: 1.1rem; margin-bottom: 15px; border-bottom: 2px solid #e2e8f0; padding-bottom: 8px;">
                    Locataire:
                </h4>
            </div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <label class="checkbox-container" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" name="fields[]" value="contrat" {{ 'contrat' in selectedFields ? 'checked' : '' }} style="width: 16px; height: 16px;">
                    <span>Contrat <span class="auto-checked"></span></span>
                </label>
                <label class="checkbox-container" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" name="fields[]" value="intitule" {{ 'intitule' in selectedFields ? 'checked' : '' }} style="width: 16px; height: 16px;">
                    <span>Intitul√© <span class="auto-checked"></span></span>
                </label>
                <label class="checkbox-container" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" name="fields[]" value="tiers" {{ 'tiers' in selectedFields ? 'checked' : '' }} style="width: 16px; height: 16px;">
                    <span>Tiers <span class="auto-checked"></span></span>
                </label>
                <label class="checkbox-container" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" name="fields[]" value="libelle_intitule" {{ 'libelle_intitule' in selectedFields ? 'checked' : '' }} style="width: 16px; height: 16px;">
                    <span>Libelle Intitul√©</span>
                </label>
                <label class="checkbox-container" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" name="fields[]" value="telephone" {{ 'telephone' in selectedFields ? 'checked' : '' }} style="width: 16px; height: 16px;">
                    <span>T√©l√©phone</span>
                </label>
                <label class="checkbox-container" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" name="fields[]" value="age" {{ 'age' in selectedFields ? 'checked' : '' }} style="width: 16px; height: 16px;">
                    <span>Age</span>
                </label>
                <label class="checkbox-container" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" name="fields[]" value="assurance_jour" {{ 'assurance_jour' in selectedFields ? 'checked' : '' }} style="width: 16px; height: 16px;">
                    <span>Assurance √† jour</span>
                </label>
                <label class="checkbox-container" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" name="fields[]" value="prelevement" {{ 'prelevement' in selectedFields ? 'checked' : '' }} style="width: 16px; height: 16px;">
                    <span>Pr√©l√®vement</span>
                </label>
                <label class="checkbox-container" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" name="fields[]" value="date_debut_contrat" {{ 'date_debut_contrat' in selectedFields ? 'checked' : '' }} style="width: 16px; height: 16px;">
                    <span>Date D√©but Contrat</span>
                </label>
                <label class="checkbox-container" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" name="fields[]" value="date_fin_contrat" {{ 'date_fin_contrat' in selectedFields ? 'checked' : '' }} style="width: 16px; height: 16px;">
                    <span>Date Fin Contrat</span>
                </label>
                <label class="checkbox-container" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" name="fields[]" value="adresse_regroupement" {{ 'adresse_regroupement' in selectedFields ? 'checked' : '' }} style="width: 16px; height: 16px;">
                    <span>Adresse de regroupement</span>
                </label>
                <label class="checkbox-container" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" name="fields[]" value="immatriculation" {{ 'immatriculation' in selectedFields ? 'checked' : '' }} style="width: 16px; height: 16px;">
                    <span>Immatriculation</span>
                </label>
                <label class="checkbox-container" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" name="fields[]" value="marque_vehicule" {{ 'marque_vehicule' in selectedFields ? 'checked' : '' }} style="width: 16px; height: 16px;">
                    <span>Marque V√©hicule</span>
                </label>
            </div>
        </div>

        <!-- Section M√©nage -->
        <div style="margin-bottom: 30px;">
            <div class="section-header">
                <h4 style="color: #4a5568; font-size: 1.1rem; margin-bottom: 15px; border-bottom: 2px solid #e2e8f0; padding-bottom: 8px;">
                    M√©nage:
                </h4>
            </div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <label class="checkbox-container" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" name="fields[]" value="nombre_occupants" {{ 'nombre_occupants' in selectedFields ? 'checked' : '' }} style="width: 16px; height: 16px;">
                    <span>Nombre d'occupants</span>
                </label>
                <label class="checkbox-container" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" name="fields[]" value="nb_adultes" {{ 'nb_adultes' in selectedFields ? 'checked' : '' }} style="width: 16px; height: 16px;">
                    <span>NB. Adultes</span>
                </label>
                <label class="checkbox-container" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" name="fields[]" value="nb_enfants" {{ 'nb_enfants' in selectedFields ? 'checked' : '' }} style="width: 16px; height: 16px;">
                    <span>NB. Enfants</span>
                </label>
                <label class="checkbox-container" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" name="fields[]" value="revenu_imposable" {{ 'revenu_imposable' in selectedFields ? 'checked' : '' }} style="width: 16px; height: 16px;">
                    <span>Revenu Imposable</span>
                </label>
            </div>
        </div>

        <!-- Section Loyer -->
        <div style="margin-bottom: 30px;">
            <div class="section-header">
                <h4 style="color: #4a5568; font-size: 1.1rem; margin-bottom: 15px; border-bottom: 2px solid #e2e8f0; padding-bottom: 8px;">
                    Loyer:
                </h4>
            </div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <label class="checkbox-container" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" name="fields[]" value="loyer" {{ 'loyer' in selectedFields ? 'checked' : '' }} style="width: 16px; height: 16px;">
                    <span>Loyer</span>
                </label>
                <label class="checkbox-container" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" name="fields[]" value="charges" {{ 'charges' in selectedFields ? 'checked' : '' }} style="width: 16px; height: 16px;">
                    <span>Charges</span>
                </label>
                <label class="checkbox-container" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" name="fields[]" value="dette" {{ 'dette' in selectedFields ? 'checked' : '' }} style="width: 16px; height: 16px;">
                    <span>Dette</span>
                </label>
                <label class="checkbox-container" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" name="fields[]" value="apl" {{ 'apl' in selectedFields ? 'checked' : '' }} style="width: 16px; height: 16px;">
                    <span>APL</span>
                </label>
                <label class="checkbox-container" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" name="fields[]" value="rls" {{ 'rls' in selectedFields ? 'checked' : '' }} style="width: 16px; height: 16px;">
                    <span>RLS</span>
                </label>
                <label class="checkbox-container" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" name="fields[]" value="loyer_plafond" {{ 'loyer_plafond' in selectedFields ? 'checked' : '' }} style="width: 16px; height: 16px;">
                    <span>Loyer Plafond</span>
                </label>
            </div>
        </div>

        <!-- Boutons d'action -->
        <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-top: 30px;">
            <button type="submit" class="btn btn-primary" style="padding: 12px 24px; font-size: 1rem;">
                üìÑ G√©n√©rer le fichier Excel (format csv)
            </button>
            
            {% if isSuperAdmin %}
                <button type="button" onclick="showQuery()" class="btn btn-secondary" style="padding: 12px 24px; font-size: 1rem;">
                    [Voir la requete]
                </button>
            {% endif %}
        </div>
    </form>

    <!-- Modal pour afficher la requ√™te (admin seulement) -->
    {% if isSuperAdmin %}
        <div id="queryModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 12px; max-width: 800px; width: 90%; max-height: 80vh; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="color: #2d3748; margin: 0;">üîç Requ√™te SQL g√©n√©r√©e</h3>
                    <button onclick="closeQueryModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #718096;">&times;</button>
                </div>
                <pre id="queryContent" style="background: #f7fafc; padding: 20px; border-radius: 8px; overflow-x: auto; white-space: pre-wrap; font-family: monospace; font-size: 14px; line-height: 1.5;"></pre>
            </div>
        </div>
    {% endif %}
{% endblock %}

{% block javascript %}
<script>
    // Fonction pour forcer la coche automatique selon les r√®gles m√©tier
    function applyAutoCheckRules() {
        // R√©cup√©rer tous les checkboxes
        const checkboxes = document.querySelectorAll('input[name="fields[]"]');
        
        // R√®gle 1: Locataire - Si Libell√© Intitul√© (3) OU T√©l√©phone (4) OU Age (5) OU Adresse de regroupement (10) est coch√©
        // ‚áí coche Tiers (2)
        const libelleIntitule = document.querySelector('input[value="libelle_intitule"]');
        const telephone = document.querySelector('input[value="telephone"]');
        const age = document.querySelector('input[value="age"]');
        const adresseRegroupement = document.querySelector('input[value="adresse_regroupement"]');
        const tiers = document.querySelector('input[value="tiers"]');
        
        if ((libelleIntitule && libelleIntitule.checked) || 
            (telephone && telephone.checked) || 
            (age && age.checked) || 
            (adresseRegroupement && adresseRegroupement.checked)) {
            if (tiers) {
                tiers.checked = true;
                tiers.disabled = true; // D√©sactiver pour √©viter la d√©coche
                tiers.parentElement.classList.add('auto-checked-field');
                // Ajouter un champ cach√© pour s'assurer que la valeur est envoy√©e
                addHiddenField('tiers');
            }
        }
        
        // R√®gle 2: Locataire - Si Tiers (2) OU Libell√© Intitul√© (3) OU T√©l√©phone (4) OU Age (5) OU Assurance √† jour (6) 
        // OU Pr√©l√®vement (7) OU Date D√©but Contrat (8) OU Date Fin Contrat (9) OU Immatriculation (11) est coch√©
        // ‚áí coche Contrat (0) ET Intitul√© (1)
        const assuranceJour = document.querySelector('input[value="assurance_jour"]');
        const prelevement = document.querySelector('input[value="prelevement"]');
        const dateDebutContrat = document.querySelector('input[value="date_debut_contrat"]');
        const dateFinContrat = document.querySelector('input[value="date_fin_contrat"]');
        const immatriculation = document.querySelector('input[value="immatriculation"]');
        const contrat = document.querySelector('input[value="contrat"]');
        const intitule = document.querySelector('input[value="intitule"]');
        
        if ((tiers && tiers.checked) || 
            (libelleIntitule && libelleIntitule.checked) || 
            (telephone && telephone.checked) || 
            (age && age.checked) || 
            (assuranceJour && assuranceJour.checked) || 
            (prelevement && prelevement.checked) || 
            (dateDebutContrat && dateDebutContrat.checked) || 
            (dateFinContrat && dateFinContrat.checked) || 
            (immatriculation && immatriculation.checked)) {
            if (contrat) {
                contrat.checked = true;
                contrat.disabled = true;
                contrat.parentElement.classList.add('auto-checked-field');
                addHiddenField('contrat');
            }
            if (intitule) {
                intitule.checked = true;
                intitule.disabled = true;
                intitule.parentElement.classList.add('auto-checked-field');
                addHiddenField('intitule');
            }
        }
        
        // R√®gle 3: M√©nage - Si Nombre d'occupants (0) OU NB. Adultes (1) OU NB. Enfants (2) OU Revenu Imposable (3) est coch√©
        // ‚áí coche Contrat (0) ET Intitul√© (1) dans Locataire
        const nombreOccupants = document.querySelector('input[value="nombre_occupants"]');
        const nbAdultes = document.querySelector('input[value="nb_adultes"]');
        const nbEnfants = document.querySelector('input[value="nb_enfants"]');
        const revenuImposable = document.querySelector('input[value="revenu_imposable"]');
        
        if ((nombreOccupants && nombreOccupants.checked) || 
            (nbAdultes && nbAdultes.checked) || 
            (nbEnfants && nbEnfants.checked) || 
            (revenuImposable && revenuImposable.checked)) {
            if (contrat) {
                contrat.checked = true;
                contrat.disabled = true;
                contrat.parentElement.classList.add('auto-checked-field');
                addHiddenField('contrat');
            }
            if (intitule) {
                intitule.checked = true;
                intitule.disabled = true;
                intitule.parentElement.classList.add('auto-checked-field');
                addHiddenField('intitule');
            }
        }
        
        // R√®gle 4: Loyer - Si Loyer (0) OU Charges (1) OU Dette (2) OU APL (3) est coch√©
        // ‚áí coche Contrat (0) ET Intitul√© (1) dans Locataire
        const loyer = document.querySelector('input[value="loyer"]');
        const charges = document.querySelector('input[value="charges"]');
        const dette = document.querySelector('input[value="dette"]');
        const apl = document.querySelector('input[value="apl"]');
        
        if ((loyer && loyer.checked) || 
            (charges && charges.checked) || 
            (dette && dette.checked) || 
            (apl && apl.checked)) {
            if (contrat) {
                contrat.checked = true;
                contrat.disabled = true;
                contrat.parentElement.classList.add('auto-checked-field');
                addHiddenField('contrat');
            }
            if (intitule) {
                intitule.checked = true;
                intitule.disabled = true;
                intitule.parentElement.classList.add('auto-checked-field');
                addHiddenField('intitule');
            }
        }
    }
    
    // Fonction pour ajouter un champ cach√© pour les valeurs coch√©es automatiquement
    function addHiddenField(fieldName) {
        // V√©rifier si le champ cach√© existe d√©j√†
        if (!document.querySelector(`input[name="fields[]"][value="${fieldName}"][type="hidden"]`)) {
            const hiddenField = document.createElement('input');
            hiddenField.type = 'hidden';
            hiddenField.name = 'fields[]';
            hiddenField.value = fieldName;
            document.querySelector('form').appendChild(hiddenField);
        }
    }
    
    // Fonction pour r√©initialiser les r√®gles (quand on d√©coche)
    function resetAutoCheckRules() {
        const checkboxes = document.querySelectorAll('input[name="fields[]"]');
        
        // R√©activer tous les checkboxes et retirer les classes
        checkboxes.forEach(checkbox => {
            checkbox.disabled = false;
            checkbox.parentElement.classList.remove('auto-checked-field');
        });
        
        // Supprimer tous les champs cach√©s
        const hiddenFields = document.querySelectorAll('input[name="fields[]"][type="hidden"]');
        hiddenFields.forEach(field => field.remove());
        
        // R√©appliquer les r√®gles
        applyAutoCheckRules();
    }
    
    // Appliquer les r√®gles au chargement de la page
    document.addEventListener('DOMContentLoaded', function() {
        // Appliquer les r√®gles une premi√®re fois
        applyAutoCheckRules();
        
        // Ajouter des √©couteurs d'√©v√©nements sur tous les checkboxes
        const checkboxes = document.querySelectorAll('input[name="fields[]"]');
        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                // Attendre un peu pour laisser le DOM se mettre √† jour
                setTimeout(() => {
                    resetAutoCheckRules();
                }, 100);
            });
        });
        
        // S'assurer que les champs coch√©s automatiquement sont inclus dans la soumission
        // m√™me s'ils sont d√©sactiv√©s visuellement
        document.querySelector('form').addEventListener('submit', function(e) {
            // Activer temporairement tous les checkboxes d√©sactiv√©s pour la soumission
            const disabledCheckboxes = document.querySelectorAll('input[name="fields[]"]:disabled');
            disabledCheckboxes.forEach(checkbox => {
                checkbox.disabled = false;
            });
            
            // Laisser le formulaire se soumettre normalement
            // Les checkboxes seront automatiquement r√©activ√©s apr√®s la soumission
        });
    });

    function showQuery() {
        const form = document.querySelector('form');
        const selectedFields = form.querySelectorAll('input[name="fields[]"]:checked');
        
        // V√©rifier qu'au moins un champ est s√©lectionn√©
        if (selectedFields.length === 0) {
            alert('Veuillez s√©lectionner au moins un champ √† extraire pour voir la requ√™te.');
            return;
        }
        
        const formData = new FormData(form);
        
        fetch('{{ path('admin_extraction_query') }}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Erreur: ' + data.error);
            } else {
                document.getElementById('queryContent').textContent = data.query;
                document.getElementById('queryModal').style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            alert('Erreur lors de la r√©cup√©ration de la requ√™te');
        });
    }

    function closeQueryModal() {
        document.getElementById('queryModal').style.display = 'none';
    }

    // Fermer le modal en cliquant √† l'ext√©rieur
    document.getElementById('queryModal')?.addEventListener('click', function(e) {
        if (e.target === this) {
            closeQueryModal();
        }
    });
</script>
{% endblock %} 