{% extends 'admin/base.html.twig' %}

{% block title %}Système - Tables Locker{% endblock %}

{% block content %}
<div class="admin-container">
    <div class="admin-header">
        <h1>🔒 Gestion des Tables Locker</h1>
        <p>Visualisation et gestion des sessions Oracle qui ont des tables verrouillées.</p>
    </div>

    <div class="admin-content">
        {% for label, messages in app.flashes %}
            {% for msg in messages %}
            <div style="background:#ebf8ff;color:#2b6cb0;border-left:4px solid #4299e1;padding:10px 14px;border-radius:8px;margin-bottom:12px;">{{ msg }}</div>
            {% endfor %}
        {% endfor %}

        <div style="display:flex; gap:10px; margin-bottom:16px; flex-wrap: wrap;">
            <a class="btn" href="{{ path('admin_system', {action: 'list', variant: 'gv_dba'}) }}" title="GV$ + DBA_OBJECTS">🔍 Lister (GV$ + DBA)</a>
            <a class="btn" href="{{ path('admin_system', {action: 'list', variant: 'v_dba'}) }}" title="V$ + DBA_OBJECTS">🔍 Lister (V$ + DBA)</a>
            <a class="btn" href="{{ path('admin_system', {action: 'list', variant: 'v_all'}) }}" title="V$ + ALL_OBJECTS">🔍 Lister (V$ + ALL)</a>
            <a class="btn btn-secondary" href="{{ path('admin_system', {action: 'list'}) }}" title="Auto">🔁 Auto</a>
            {% if locks is defined and locks|length > 0 %}
            <form method="POST" action="{{ path('admin_system_kill_all') }}">
                <button type="submit" class="btn btn-secondary" onclick="return confirm('Confirmer la suppression de TOUTES les sessions verrouillant ?');">🗑️ Tuer toutes les sessions</button>
            </form>
            {% endif %}
        </div>

        {% if error %}
            <div style="background:#fed7d7;color:#c53030;border-left:4px solid #e53e3e;padding:10px 14px;border-radius:8px;margin-bottom:12px;white-space:pre-wrap;">{{ error }}</div>
        {% endif %}
        {% if message %}
            <div style="text-align:center;color:#718096;">{{ message }}</div>
        {% endif %}

        {% if locks is defined and locks|length > 0 %}
        <div class="table-container">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>SID</th>
                        <th>Serial</th>
                        <th>Username</th>
                        <th>OS User</th>
                        <th>Status</th>
                        <th>Machine</th>
                        <th>Programme</th>
                        <th>Objet</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in locks %}
                    <tr>
                        <td>{{ row.sid }}</td>
                        <td>{{ row.serial ?? row['serial#'] }}</td>
                        <td>{{ row.username|default('-') }}</td>
                        <td>{{ row.osuser|default('-') }}</td>
                        <td>{{ row.status|default('-') }}</td>
                        <td>{{ row.machine|default('-') }}</td>
                        <td>{{ row.program|default('-') }}</td>
                        <td>{{ row.owner|default('') }} {{ row.object_name|default('') }}</td>
                        <td>
                            <form method="POST" action="{{ path('admin_system_kill') }}" onsubmit="return confirm('Tuer la session {{ row.sid }}/{{ row.serial ?? row['serial#'] }} ?');" style="display:inline;">
                                <input type="hidden" name="sid" value="{{ row.sid }}" />
                                <input type="hidden" name="serial" value="{{ row.serial ?? row['serial#'] }}" />
                                <button type="submit" class="btn" style="padding:6px 10px;">🗑️ Tuer</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
